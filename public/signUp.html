<!doctype html>
<html lang="en">

<head>
    <title>iB New Account</title>
    <link rel="icon" type="image/png" sizes="16x16" href="/public/images/favicon.ico">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="/public/css/style01.css">
    <link href="https://fonts.googleapis.com/css?family=Lobster" rel="stylesheet">
</head>

<body>
    <script>
    window.fbAsyncInit = function() {
        FB.init({
            appId: "192427987971498",
            xfbml: true,
            version: 'v2.6'
        });
    };
    (function(d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) { return; }
        js = d.createElement(s);
        js.id = id;
        js.src = "//connect.facebook.net/en_US/sdk.js";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));
    </script>
    <div id="container">
        <div class="header container-fluid">
            <div class="row justify-content-center">
                <nav class="navbar navbar-inverse navbar-fixed-top my-logo col-sm-10" role="navigation">
                    <img src="/public/images/logo.png" alt="iceBreakrBear" id="logo" class="justify-content-center">
                </nav>
            </div>
        </div>
        <div class="mainBody container-fluid">
            <div class="row justify-content-center">
                <div class="signIn col-sm-6 text-center">
                    <p>Sign up</p>
                    <br>
                    <h4 id="errorBox" class="text-center" style="color:red; font-family:Arial; font-size:30px"></h4>
                    <br>
                    <!-- <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal">Facebook log in</button> -->
                    <!--  <button onclick="facebookSignin()">Facebook Signin</button> -->
                    <div class="fb-login-button" data-max-rows="1" data-size="large" data-button-type="continue_with" data-show-faces="false" data-auto-logout-link="false" data-use-continue-as="false" onclick="facebookSignin()" style="margin: 0 auto; margin-left: 15px; width:60%"></div>
                </div>
            </div>
            <br>
            <div class="mainBody container-fluid">
                <div class="row justify-content-center">
                    <div class="signUp col-sm-6 text-center">
                        <form>
                            <!--   <form action="/api/users" method="POST"> -->
                            <div class="form-group sign-up-group row">
                                <label for="inputFirstName" class="inputLabel col-2 col-form-label">First Name</label>
                                <div class="col-sm-10">
                                    <input class="form-control" type="text" name="firstName" value="" id="inputFirstName" required>
                                </div>
                            </div>
                            <div class="form-group sign-up-group row">
                                <label for="inputLastName" class="inputLabel col-2 col-form-label">Last Name</label>
                                <div class="col-sm-10">
                                    <input class="form-control" type="text" name="lastName" value="" id="inputLastName" required>
                                </div>
                            </div>
                            <div class="form-group sign-up-group row">
                                <label for="age" class="inputLabel col-2 col-form-label">DOB</label>
                                <div class="col-sm-10">
                                    <input class="form-control" type="date" name="age" value="" id="inputAge" required>
                                </div>
                            </div>
                            <div class="form-group sign-up-group row">
                                <label for="example-tel-input" class="inputLabel col-2 col-form-label">Telephone</label>
                                <div class="col-sm-10">
                                    <input class="form-control" type="tel" name="phoneNumber" placeholder="1-(555)-555-5555" id="inputTel" required>
                                </div>
                            </div>
                            <div class="form-group sign-up-group row">
                                <label for="inputEmail" class="inputLabel col-2 col-form-label">Email</label>
                                <div class="col-sm-10">
                                    <input class="form-control" type="email" name="email" id="inputEmail" required>
                                </div>
                            </div>
                            <div class="form-group sign-up-group row">
                                <label for="inputPassword" class="inputLabel col-2 col-form-label">Password</label>
                                <div class="col-sm-10">
                                    <input class="form-control" type="password" name="password" id="inputPassword" required>
                                </div>
                            </div>
                            <div class="form-group sign-up-group row">
                                <div class="col-sm-10" style="margin: 0 auto; margin-top:20px">
                                    <button type="button" class="btn btn-lg btn-primary" style="border:#4267b2" id="sign-up-new">Sign up!</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <!--============================ THis is the Facebook Modal =============== -->
            <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Facebook Login</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            ...
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary">Login</button>
                        </div>
                    </div>
                </div>
            </div>
        <footer>
            <div class="row justify-content-center">
                <p id="footer">&copy; iceBreakr 2017</p>
            </div>
        </footer>
    </div>
    <!--========================================================================= -->
    <!--========================================================================= -->
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>

    <!--HERE IS THE SignUp PAGE SCRIPT -->
    <script src="https://www.gstatic.com/firebasejs/4.6.2/firebase.js"></script>
    <script type="text/javascript">
    $(document).ready(function() {

        var provider = new firebase.auth.FacebookAuthProvider();
        provider.addScope('user_birthday');
        provider.addScope('user_phonenumber');
        provider.addScope('user_gender');

        function facebookSignin() {
            console.log("calling facebook signin");

            firebase.auth().signInWithPopup(provider)
                .then(function(result) {
                    console.log("in facebook auth...");
                    var token = result.credential.accessToken;
                    var user = result.user;

                    console.log("token = " + token);
                    console.log("user = " + user);
                    result.redirect("/profileupdate");

                    var newUser = {
                        firstName: firstName,
                        lastName: lastName,
                        phoneNumber: telephone,
                        // age: age,
                        email: email,
                        password: password
                    }

                // Send the POST request.
                    $.post("/api/users", newUser)
                        .done(function(data) {
                            // alert("Data Loaded: " + data);
                        }).catch(function(error) {
                            console.log(error.code);
                            console.log(error.message);
                        });
                });
        }

        function facebookSignout() {
            firebase.auth().signOut()

                .then(function() {
                    console.log('Signout successful!')
                }, function(error) {
                    console.log('Signout failed')
                });
        }



        // $(document).ready(function() {
        //Sign up new users
        var email = $("#inputEmail").val().trim();
        var password = $("#inputPassword").val().trim();


        //Initialize Firebase >> hide this before the end in a PW file...
        var config = {
            apiKey: "AIzaSyCK6hRlRpzJEd8RsN5hozVosxZalbgsQ0M",
            authDomain: "ice-breaker-app-165bd.firebaseapp.com",
            databaseURL: "https://ice-breaker-app-165bd.firebaseio.com",
            projectId: "ice-breaker-app-165bd",
            storageBucket: "ice-breaker-app-165bd.appspot.com",
            messagingSenderId: "673248316614"
        };

        firebase.initializeApp(config);
        // var firebase = require("firebase");
        // var admin = require("firebase-admin");

        // admin.initializeApp(functions.config().firebase);
        // firebase.initializeApp(functions.config().firebase);
        // Get the Auth service for the default app
        var user = firebase.auth().currentUser;


        //Sign up existing users
        function createProfile() {
            var email2 = $("#inputEmail").val().trim();
            var password2 = $("#inputPassword").val().trim();
            if (email2.length < 4) {
                $("#errorBox").html("<br/><h4>*Please enter an email address.</h4>");
                return;
            }
            if (password2.length < 4) {
                 $("#errorBox").html("<br/><h4>*Please enter a password.</h4>");
                return;
            }
            firebase.auth().createUserWithEmailAndPassword(email2, password2).catch(function(error) {
                if (error) {
                    var errorCode = error.code;
                    var errorMessage = error.message;
                    if (errorCode === "auth/weak-password") {
                        alert("Your password is too weak. Please try again.. we don't want someone to break the ice for you!");
                        console.log("User's password is too weak.");
                    } else {
                        alert("batman" + errorMessage)
                        console.log("You have the current error message:" + errorMessage + ", and error code: " + errorCode + ".");
                    }
                    console.log(error);
                }

            })

            //Firebase presence stuff.
            // var myConnectionsRef = new Firebase("https://ice-breaker-app-165bd.firebaseio.com" + '/users/:id/connections');
            // var connectedRef = new Firebase("https://ice-breaker-app-165bd.firebaseio.com" + '/.info/connected');
            // connectedRef.on('value', function(snap) {
            //     if (snap.val() === true) {
            //         // We're connected (or reconnected)! Do anything here that should happen only if online (or on reconnect)
            //         // add this device to my connections list
            //         alert("connected");
            //     } else {
            //         alert("not connected");
            //     }

            //     var con = myConnectionsRef.push(true);
            //     // when I disconnect, remove this device
            //     con.onDisconnect().remove();

            // })
        };

        //Click-Event for Sign-Up Button on HTML.
        $("#sign-up-new").on("click", function() {
            createProfile();
            SignIn();
            sendEmailVerification();

            //console.log("testing the validation in sign-up-new");

            var email = $("#inputEmail").val().trim();
            var password = $("#inputPassword").val().trim();
            var firstName = $("#inputFirstName").val().trim();
            var lastName = $("#inputLastName").val().trim();
            var dob = $("#inputAge").val();
            var telephone = $("#inputTel").val();

            console.log("dob = " + dob);
            console.log("telephone = " + telephone);
            //var phoneNumber = telephone.toString();

            var number = [1, 2, 3, 4, 5, 6, 7, 8, 9, 0];
            var atSign = function() {
                email.includes("@");
            }
            var dotCom = function() {
                email.includes(".com");
            }
            var number = function() {
                for (var i = 0; i < number.length; i++) {
                    if (password.includes(number[i])) {
                        return true;
                    } else {
                        return false;
                    }
                }
            }
            var dobYear = function() {
                var dobString = dob.length;
                var dobArray = Array.from(dobString);
                var year = dobArray.slice(1, 5); //slice "ends" on the index # FOLLOWING the index value you wish to be the last in the new array.
                year.toString();
                console.log("dob year = " + year);
                console.log("typeof - for the dob year = ")
                console.log(typeOf(year));

                var date = new Date();
                var currentYear = date.getFullYear();

                var numYear = parseInt(year);
                if (numYear < 1920 || numYear > currentYear) {
                    return false;
                } else {
                    return true;
                }
            }


            if (email.length < 6 || atSign === false || dotCom === false) {
                $("#errorBox").html("<br/><h4>*Please enter a avalid email address.</h4>");
                return;
            }
            if (password.length < 6 || !number) {
                $("#errorBox").html("<br/><h4>*Please enter a valid password.</h4>");
                return;
            }
            if (firstName.length < 1) {
                 $("#errorBox").html("<br/><h4>*Please enter a valid first name.</h4>");
                return;
            }
            if (lastName.length < 1) {
                $("#errorBox").html("<br/><h4>*Please enter a valid last name.</h4>");
                return;
            }
            if (dob === "") { //barebones verifcation, to make sure data was entered
                $("#errorBox").html("<br/><h4>*Please enter in a valid dob.</h4>");
            }
            //wrong splicing failing to validate
            // if (dob.length !== 8 || dobYear === false) {
            //     alert('Please enter a valid date of birth.');
            //     return;
            // }
            if (telephone.length !== 11) {
                $("#errorBox").html("<br/><h4> Please enter a valid phone number, including the number '1' and full area code. Be sure NOT to include any hyphens! :)</h4>");
                return;
            } else {
                var newUser = {
                    firstName: firstName,
                    lastName: lastName,
                    phoneNumber: telephone,
                    age: dob,
                    email: email,
                    password: password
                }

            }
            // Send the POST request.
            $.post("/api/users", newUser)
                .done(function(data) {
                    // alert("Data Loaded: " + data);
                    window.location.pathname = "/profileupdate";
                });
            console.log("POSTED THE DATA!");
        });


        //Sign in existing users
        function SignIn() {
            if (firebase.auth().currentUser) {
                // [START signout]
                firebase.auth().signOut();
                // [END signout]    
            } else {
                if (email.length < 4) {
                    $("#errorBox").html("<br/><h4>*Please enter an email address.</h4>");
                    return;
                }
                if (password.length < 4) {
                    $("#errorBox").html("<br/><h4>*Please enter a password.</h4>");
                    return;
                }
                // Sign in with email and pass.
                // [START authwithemail]

                firebase.auth().signInWithEmailAndPassword(email, password).catch(function(error) {
                    // Handle Errors here.
                    var errorCode = error.code;
                    var errorMessage = error.message;
                    // [START_EXCLUDE]
                    if (errorCode === 'auth/wrong-password' && wrongPass <= 2) {
                        alert('Wrong password.');
                        var wrongPass = 0;
                        wrongPass++;
                    } else if (errorCode === "auth/wrong-password" && wrongPass >= 3) {
                        alert('Your account is now locked.  Please visit your email to reset your password.');
                        sendPasswordReset();
                    } else {
                        $("#errorBox").html("<br/><h4>*You have an error: " + errorMessage + "</h4>");
                    }
                    console.log(error);
                    $("#sign-up-new").disabled = false;
                    // [END_EXCLUDE]

                });
            }
            $("#sign-up-new").disabled = true;
        };
        //Click-Event for Sign-In Button on HTML.
        // $("#sign-up-new").on("click", function() {
        //     SignIn();
        // });



        //Get a user's profile
        //To get a user's profile information, use the properties of an instance of User. 
        var verify = ""; //name, email, photoUrl, uid, emailVerified;
        if (user != null) {
            name = user.displayName;
            email = user.email;
            photoUrl = user.photoURL;
            emailVerified = user.emailVerified;
            uid = user.uid; // The user's ID, unique to the Firebase project. Do NOT use
            // this value to authenticate with your backend server, if
            // you have one. Use User.getToken() instead.
        }

        //Sends an email verification to the user.
        function sendEmailVerification() {
            // [START sendemailverification]
            var email = $("#inputEmail").val().trim();

            var atSign = function() {
                email.includes("@");
            }
            var dotCom = function() {
                email.includes(".com");
            }

            firebase.auth().signInWithEmailAndPassword(email, password).catch(function(error) {
                // Handle Errors here.
                var errorCode = error.code;
                var errorMessage = error.message;
                var user = firebase.auth().currentUser;

                console.log("testing the firebase auth lin 440");
                if (!email) {
                    $("#errorBox").html("<br/><h4>*Please type in an email.</h4>");
                } else if (atSign === false || dotCom === false) {
                    $("#errorBox").html("<br/><h4>*Please enter a valid email.</h4>");
                } else {
                    if (errorCode === "auth/invalid-email") {
                        alert("Please type in a valid email.  We want to make sure your account is secure. :)");
                        return console.log("User's amail is already in use.");
                    } else if (errorCode === "auth/account-exists-with-different-credential") {
                        $("#errorBox").html("<br/><h4>Your email is already taken!</h4>");
                        return console.log("User's amail is already in use.");
                    } else {
                        console.log("firebase auth errorMessage = " + errorMessage);
                        firebase.auth().currentUser.sendEmailVerification() //WHY DOES THIS KEEP CHANGING!!?
                            .then(function() {
                                $("#errorBox").html("<br/><h4>Your email verification has been sent!</h4>");
                                console.log("User has been sent an email verification!");
                                // window.location.pathname = "/profileupdate";
                               

                                // user.displayName = "firstName" + " " + "lastName";
                                // console.log("Email Verification has been sent to the following user: ")
                                // console.log(user.displayName);
                            });
                        console.log("testing the firebase auth - AFTER the posting...");
                    }
                }
            });
        }


        //Sends an password reset email to the user.
        function sendPasswordReset() {
            // [START sendpasswordemail]
            firebase.auth().sendPasswordResetEmail(email)
                .then(function() {
                    // [START_EXCLUDE]
                    $("#errorBox").html("<br/><h4>Password Reset Email Sent!</h4>");
                    console.log("Password Reset has been sent to the user: " + user);
                    // [END_EXCLUDE]
                }).catch(function(error) {
                    // Handle Errors here.
                    var errorCode = error.code;
                    var errorMessage = error.message;
                    // [START_EXCLUDE]
                    if (errorCode == 'auth/invalid-email') {
                        $("#errorBox").html("<br/><h4>You have the following error message: " + errorMessage + "</h4>");
                    } else if (errorCode == 'auth/user-not-found') {
                        $("#errorBox").html("<br/><h4>You have the following error message: " + errorMessage + "</h4>");
                    }
                    console.log(error);
                    // [END_EXCLUDE]
                });
            // [END sendpasswordemail];
        }

        function initApp() {
            // Listening for auth state changes.
            // [START authstatelistener]
            firebase.auth().onAuthStateChanged(function(user) {
                // [START_EXCLUDE silent]
                $('#inputEmail').disabled = false;
                // [END_EXCLUDE]
                if (user) {
                    // User is signed in.
                    var displayName = user.displayName;
                    var emaildb = user.email;
                    console.log("Email from database is: " + emaildb);
                    console.log("Email from input is: " + email);

                    var emailVerified = user.emailVerified;
                    var photoURL = user.photoURL;
                    var isAnonymous = user.isAnonymous;
                    var uid = user.uid;
                    var providerData = user.providerData;

                    // [START_EXCLUDE]
                    $("#sign-in-status").text("Signed in"); //create div for this button...
                    $("#sign-out").text("Sign out"); //if they click the sign-in button, then they will sign out. (Make this button on most pages...)
                    $('#account-details').text(JSON.stringify(user, null, " ")); //CHECK OUT the 

                    if (!emailVerified) {
                        $("#inputEmail").disabled = false;
                    }
                    // [END_EXCLUDE]
                } else {
                    // User is signed out.
                    // [START_EXCLUDE]
                    $("#sign-in-status").text("Signed out");
                    $("#sign-in").text("Sign in");
                    $("#account-details").text("null");
                    // [END_EXCLUDE]
                }
                // [START_EXCLUDE silent]
                $("#sign-in").disabled = false;
                // [END_EXCLUDE]
            });
            // [END authstatelistener]
            $(document).on("click", "#sign-in", SignIn);
            // $(document).on("click", "#sign-up-new", createProfile);
        }
        window.onload = function() {
            initApp();
        };

    });

    //For the firebase presence status:
    // var myConnectionsRef = new Firebase(config.databaseURL + '/users/:id/connections');
    // // stores the timestamp of my last disconnect (the last time I was seen online)
    // var lastOnlineRef = new Firebase(config.databaseURL + '/users/:id/lastOnline');
    // var connectedRef = new Firebase(config.databaseURL + '/.info/connected');
    // connectedRef.on('value', function(snap) {
    //     if (snap.val() === true) {
    //         // We're connected (or reconnected)! Do anything here that should happen only if online (or on reconnect)
    //         // add this device to my connections list
    //         // this value could contain info about the device or a timestamp too
    //         var con = myConnectionsRef.push(true);
    //         // when I disconnect, remove this device
    //         con.onDisconnect().remove();
    //         // when I disconnect, update the last time I was seen online
    //         lastOnlineRef.onDisconnect().set(Firebase.ServerValue.TIMESTAMP);
    //     }
    // });
    </script>
</body>

</html>